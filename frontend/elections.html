<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>E-Voting – Elections</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<div class="wrap">
  <h1>E-Voting <span class="badge">Elections</span></h1>
  <div class="nav">
    <a href="index.html">Login</a>
    <a class="active" href="elections.html">Elections</a>
    <a href="vote.html">Vote</a>
    <a href="results.html">Results</a>
  </div>

  <div class="card">
    <h2>Pick Election</h2>
    <div class="grid2">
      <div>
        <label>Election</label>
        <select id="electionSelect"></select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnLoad">Load Elections</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Candidates</h2>
    <div id="candidates" class="list"><div class="muted">Load elections to view candidates…</div></div>
  </div>
</div>

<script src="utils.js"></script>
<script>
requireToken();

const sel = document.getElementById('electionSelect');
const box = document.getElementById('candidates');

async function loadElections() {
  const es = await apiGet(cfg.authBase, '/elections', true);
  sel.innerHTML = '';
  es.forEach(e => {
    const opt = document.createElement('option');
    opt.value = e.id; opt.textContent = `#${e.id} — ${e.title}`;
    sel.appendChild(opt);
  });
  cfg.electionId = es?.[0]?.id || 1; sel.value = cfg.electionId; saveCfg();
  await loadCandidates();
}

async function loadCandidates() {
  cfg.electionId = Number(sel.value); saveCfg();
  const cs = await apiGet(cfg.authBase, `/elections/${cfg.electionId}/candidates`, true);
  box.innerHTML = '';
  cs.forEach(c => {
    const row = document.createElement('div');
    row.className = 'flex';
    row.innerHTML = `
      <div style="flex:1">
        <b>${c.name}</b> <span class="pill">#${c.id}</span>
      </div>
      <button data-id="${c.id}">Choose</button>`;
    row.querySelector('button').onclick = () => {
      cfg.candidateId = c.id; saveCfg();
      alert(`Selected ${c.name} (ID ${c.id}) for election #${cfg.electionId}. Go to Vote page.`);
      location.href = 'vote.html';
    };
    box.appendChild(row);
  });
}

document.getElementById('btnLoad').onclick = loadElections;
sel.onchange = loadCandidates;

loadElections().catch(err => box.innerHTML = `<div class="muted small">${err.message}</div>`);
</script>
</body>
</html>
